# GitLab CI/CD configuration for air-gapped marimo Pages deployment
#
# This pipeline runs on a GitLab runner WITH internet access.
# It builds a fully self-contained static site and deploys it to GitLab Pages.
# Browsers accessing the Pages site need NO internet — everything is bundled.
#
# Equivalent to the GitHub Actions workflow in .github/workflows/deploy.yml.

stages:
  - upload
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  PIP_CONFIG_FILE: "$CI_PROJECT_DIR/pip.conf"

# Cache pip downloads between runs to speed up builds
cache:
  key: pip-cache
  paths:
    - .pip-cache/

# Upload Pyodide packages to the GitLab Generic Package Registry.
# Run this once per Pyodide version to populate the registry, then
# configure pip.conf [pyodide] cdn-url to point to it.
# Triggered manually from the GitLab UI (Run pipeline → play button).
upload-pyodide:
  stage: upload
  image: python:3.12-slim
  rules:
    - if: $CI_COMMIT_BRANCH == "pages"
      when: manual
      allow_failure: true
  script:
    # Set PYODIDE_VERSION as a CI/CD variable when triggering this job.
    # Find it in the build log or run: python -c "import marimo._pyodide.pyodide_versions as pv; print(pv.PYODIDE_VERSION)"
    - |
      if [ -z "$PYODIDE_VERSION" ]; then
        echo "Error: Set the PYODIDE_VERSION variable (e.g. 0.27.7) when running this job."
        echo "Check the build job log for the version marimo uses."
        exit 1
      fi
    - echo "Uploading Pyodide $PYODIDE_VERSION packages to registry..."
    - python scripts/upload_pyodide_packages.py --pyodide-version "$PYODIDE_VERSION"

build:
  stage: build
  image: python:3.12-slim
  interruptible: true
  rules:
    - if: $CI_COMMIT_BRANCH == "pages"
  script:
    - MARIMO_VERSION=$(python -c "import re; print(re.search(r'MARIMO_VERSION = \"([^\"]+)\"', open('scripts/build.py').read()).group(1))")
    - pip install "marimo==$MARIMO_VERSION" packaging
    - python scripts/build.py --mode edit --slim
    - cp oauth-test.html _site/
  artifacts:
    paths:
      - _site
    expire_in: 1 hour

pages:
  stage: deploy
  needs:
    - job: build
      artifacts: true
  script:
    # GitLab Pages requires the output directory to be named "public"
    - rm -rf public
    - mv _site public
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "pages"

# Optional: Add COOP/COEP headers for SharedArrayBuffer support
# If your GitLab Pages instance uses nginx, you may need to configure
# these headers at the GitLab admin level or via a custom domain config:
#
#   Cross-Origin-Opener-Policy: same-origin
#   Cross-Origin-Embedder-Policy: require-corp
#
# Without these headers, Pyodide may fall back to a slower single-threaded
# mode, but should still function correctly.
